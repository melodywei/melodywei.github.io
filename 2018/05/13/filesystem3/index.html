<!DOCTYPE html>












  


<html class="theme-next gemini use-motion" lang="zh-Hans">
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">












<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">






















<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=6.5.0" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=6.5.0">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=6.5.0">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=6.5.0">


  <link rel="mask-icon" href="/images/logo.svg?v=6.5.0" color="#222">









<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '6.5.0',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta name="description" content="文件描述符在之前介绍的概念中，inode是用来表示一个文件的，用于描述文件的存储信息，文件的权限等。但这个inode结构是操作系统为自己的文件系统准备的数据结构，仅供其内部使用，与用户的关系不大，接下来要介绍的文件描述符才是用户能够使用的结构。 在linux系统中，读写文件的本质是先通过文件的inode找到文件数据块的扇区地址，随后对这些扇区的数据进行读写，从而实现了文件的读写。 对用户进程来说，">
<meta property="og:type" content="article">
<meta property="og:title" content="十七. 文件系统三(文件的创建)">
<meta property="og:url" content="https://modifying.github.io/2018/05/13/filesystem3/index.html">
<meta property="og:site_name" content="melodyのblog">
<meta property="og:description" content="文件描述符在之前介绍的概念中，inode是用来表示一个文件的，用于描述文件的存储信息，文件的权限等。但这个inode结构是操作系统为自己的文件系统准备的数据结构，仅供其内部使用，与用户的关系不大，接下来要介绍的文件描述符才是用户能够使用的结构。 在linux系统中，读写文件的本质是先通过文件的inode找到文件数据块的扇区地址，随后对这些扇区的数据进行读写，从而实现了文件的读写。 对用户进程来说，">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="https://melody-pic-1254202436.cos.ap-guangzhou.myqcloud.com/pic/180512/Ba42f1HEEc.png?imageslim">
<meta property="og:image" content="https://melody-pic-1254202436.cos.ap-guangzhou.myqcloud.com/pic/180512/mcCchbaaE9.png?imageslim">
<meta property="og:image" content="https://melody-pic-1254202436.cos.ap-guangzhou.myqcloud.com/pic/180513/3D3gdG5cdL.png?imageslim">
<meta property="og:image" content="https://melody-pic-1254202436.cos.ap-guangzhou.myqcloud.com/pic/180513/CedA9m8Df4.png?imageslim">
<meta property="og:updated_time" content="2018-12-08T16:21:49.748Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="十七. 文件系统三(文件的创建)">
<meta name="twitter:description" content="文件描述符在之前介绍的概念中，inode是用来表示一个文件的，用于描述文件的存储信息，文件的权限等。但这个inode结构是操作系统为自己的文件系统准备的数据结构，仅供其内部使用，与用户的关系不大，接下来要介绍的文件描述符才是用户能够使用的结构。 在linux系统中，读写文件的本质是先通过文件的inode找到文件数据块的扇区地址，随后对这些扇区的数据进行读写，从而实现了文件的读写。 对用户进程来说，">
<meta name="twitter:image" content="https://melody-pic-1254202436.cos.ap-guangzhou.myqcloud.com/pic/180512/Ba42f1HEEc.png?imageslim">






  <link rel="canonical" href="https://modifying.github.io/2018/05/13/filesystem3/">



<script type="text/javascript" id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>十七. 文件系统三(文件的创建) | melodyのblog</title>
  




<script async src="https://www.googletagmanager.com/gtag/js?id=UA-131168677-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-131168677-1');
</script>



  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?2fa2044c78f4a75b300904570ea19f8f";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>






  <noscript>
  <style type="text/css">
    .use-motion .motion-element,
    .use-motion .brand,
    .use-motion .menu-item,
    .sidebar-inner,
    .use-motion .post-block,
    .use-motion .pagination,
    .use-motion .comments,
    .use-motion .post-header,
    .use-motion .post-body,
    .use-motion .collection-title { opacity: initial; }

    .use-motion .logo,
    .use-motion .site-title,
    .use-motion .site-subtitle {
      opacity: initial;
      top: initial;
    }

    .use-motion {
      .logo-line-before i { left: initial; }
      .logo-line-after i { right: initial; }
    }
  </style>
</noscript>

</head>

<body itemscope="" itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope="" itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">melodyのblog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="切换导航栏">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home">

    
    
    
      
    

    

    <a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i> <br>首页</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-about">

    
    
    
      
    

    

    <a href="/about/" rel="section"><i class="menu-item-icon fa fa-fw fa-user"></i> <br>关于</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-categories">

    
    
    
      
    

    

    <a href="/categories/" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i> <br>分类</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">

    
    
    
      
    

    

    <a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i> <br>归档</a>

  </li>

      
      
    </ul>
  

  

  
</nav>



  



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
            

          
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://modifying.github.io/2018/05/13/filesystem3/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="melody">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="melodyのblog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">十七. 文件系统三(文件的创建)
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2018-05-13 20:30:00" itemprop="dateCreated datePublished" datetime="2018-05-13T20:30:00+08:00">2018-05-13</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2018-12-09 00:21:49" itemprop="dateModified" datetime="2018-12-09T00:21:49+08:00">2018-12-09</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing"><a href="/categories/kernel/" itemprop="url" rel="index"><span itemprop="name">kernel</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h1 id="文件描述符"><a href="#文件描述符" class="headerlink" title="文件描述符"></a>文件描述符</h1><p>在之前介绍的概念中，inode是用来表示一个文件的，用于描述文件的存储信息，文件的权限等。但这个inode结构是操作系统为自己的文件系统准备的数据结构，仅供其内部使用，与用户的关系不大，接下来要介绍的文件描述符才是用户能够使用的结构。</p>
<p>在linux系统中，读写文件的本质是先通过文件的inode找到文件数据块的扇区地址，随后对这些扇区的数据进行读写，从而实现了文件的读写。</p>
<p>对用户进程来说，一个进程可以多次的打开同一个文件，一个文件也可以被多个进行同时打开。对于这个被多次打开的文件，每打开一次，都需要一个结构来记录该文件目前的状态。比如说A进行第一次打开1.txt的时候，读取到了第10行的位置，第二次打开1.txt的时候，读取到了20行的位置。这里的10行，20行就是打开的文件状态中的文件偏移量，它记录的是相对于文件首地址的一个偏移。即使一个文件被同时多次打开，各自操作的偏移量也互不影响。</p>
<p>也就是说，会有一个文件结构来描述文件打开后，文件读写的偏移量等信息。一个文件对应一个inode，一个文件可以被多次打开，即一个inode对应多个文件结构。</p>
<p>文件描述符的基本结构如下</p>
<p><img src="https://melody-pic-1254202436.cos.ap-guangzhou.myqcloud.com/pic/180512/Ba42f1HEEc.png?imageslim" alt="文件描述符的结构"></p>
<p>接下来通过linux的open函数来了解一下文件描述符</p>
<p>open的函数原型如下<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">open</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *pathname, inf flags)</span></span>;</span><br></pre></td></tr></table></figure></p>
<p>成功调用该函数之后，它会返回文件pathname的文件描述符，该返回值是一个int的数值，肯定不是代表真正的文件描述符结构。它是作为进程pcb中文件描述符数组的下标索引。通过这个下标在进程pcb中找到某个数据。大家可能会认为这个数据就是真正的文件描述符了。其实不然，在进程pcb的文件描述符数组中，记录的任然不是真正的文件描述符结构，它是一个指针数组，数组中的数据指向文件表中某个文件结构，该文件结构就是真正记录被打开文件的信息所在。</p>
<p>该过程比较复杂，将其分解为下面四步</p>
<ol>
<li>调用open函数，得到一个文件描述符</li>
<li>将第一步得到的文件描述符作为进程pcb中文件描述符数组的下标，取得该下标对应的数据</li>
<li>将第二步得到的数据，相当于是一个指针，从这个指针中取到对应的文件结构</li>
<li>从该文件结构中获取到记录的文件信息</li>
</ol>
<p>通过一副图来描述一下这个过程</p>
<p><img src="https://melody-pic-1254202436.cos.ap-guangzhou.myqcloud.com/pic/180512/mcCchbaaE9.png?imageslim" alt="mark"></p>
<p>看到这里获取会有一个疑问，为什么pcb中不直接记录文件的描述符信息，而是指向了其他的区域。</p>
<p>因为记录文件信息的描述符较大，每打开一次文件，就需要记录一次。打开的文件多了之后，进程pcb的结构就会变的很大，而pcb占用的内存通常就是几个页框，linux中的pcb也只是2页框的大小，所以这些信息不会被放入pcb中。</p>
<p>看完了上面的理论之后，接下来就来具体看一下文件描述符的代码实现</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">task_struct</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="keyword">int32_t</span> fd_table[MAX_FILES_OPEN_PER_PROC];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这是在进程pcb中记录的文件描述符数组，为了简化实现，这里并不是一个指针数组。里面记录的数据就是对应文件表的下标值。通过该下标去文件表中找到对应的文件结构。</p>
<p>文件描述符的初始化</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">init_thread</span><span class="params">(task_struct* pthread, <span class="keyword">char</span>* name, <span class="keyword">int</span> prio)</span> </span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    pthread-&gt;fd_table[<span class="number">0</span>] = <span class="number">0</span>;</span><br><span class="line">    pthread-&gt;fd_table[<span class="number">1</span>] = <span class="number">1</span>;</span><br><span class="line">    pthread-&gt;fd_table[<span class="number">2</span>] = <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">uint8_t</span> fd_idx = <span class="number">3</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span>(fd_idx &lt; MAX_FILES_OPEN_PER_PROC)</span><br><span class="line">    &#123;</span><br><span class="line">        pthread-&gt;fd_table[fd_idx++] = <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>文件描述符的前三个文件结构将作为标准输入，标准输出，标准错误预留出来。置为-1表示该文件描述符可被分配。</p>
<p>文件描述符结构和文件表<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">file</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="keyword">uint32_t</span> fd_pos; <span class="comment">// 记录当前文件操作的偏移地址,以0为起始,最大为文件大小-1</span></span><br><span class="line">    <span class="keyword">uint32_t</span> fd_flag;<span class="comment">// 文件打开的标志</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">inode</span> *<span class="title">fd_inode</span>;</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 文件表</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">file</span> <span class="title">file_table</span>[<span class="title">MAX_FILE_OPEN</span>];</span></span><br></pre></td></tr></table></figure></p>
<p>文件描述符只存储了打开一个需要记录的最基础的信息。文件表的本质就是一个文件描述符结构的数组。</p>
<h1 id="创建文件"><a href="#创建文件" class="headerlink" title="创建文件"></a>创建文件</h1><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* 创建文件,若成功则返回文件描述符,否则返回-1 */</span></span><br><span class="line"><span class="keyword">int32_t</span> file_create(struct dir *parent_dir, <span class="keyword">char</span> *filename, <span class="keyword">uint8_t</span> flag)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">/* 后续操作的公共缓冲区 */</span></span><br><span class="line">    <span class="keyword">void</span> *io_buf = sys_malloc(<span class="number">1024</span>);</span><br><span class="line">    <span class="keyword">if</span> (io_buf == <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">uint8_t</span> rollback_step = <span class="number">0</span>; <span class="comment">// 用于操作失败时回滚各资源状态</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 为新文件分配inode */</span></span><br><span class="line">    <span class="keyword">int32_t</span> inode_no = inode_bitmap_alloc(cur_part);</span><br><span class="line">    <span class="keyword">if</span> (inode_no == <span class="number">-1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 此inode要从堆中申请内存,不可生成局部变量(函数退出时会释放)</span></span><br><span class="line"><span class="comment">     * 因为file_table数组中的文件描述符的inode指针要指向它.*/</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">inode</span> *<span class="title">new_file_inode</span> = (<span class="title">struct</span> <span class="title">inode</span> *)<span class="title">sys_malloc</span>(<span class="title">sizeof</span>(<span class="title">struct</span> <span class="title">inode</span>));</span></span><br><span class="line">    <span class="keyword">if</span> (new_file_inode == <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        rollback_step = <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">goto</span> rollback;</span><br><span class="line">    &#125;</span><br><span class="line">    inode_init(inode_no, new_file_inode); <span class="comment">// 初始化inode</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 返回的是file_table数组的下标 */</span></span><br><span class="line">    <span class="keyword">int</span> fd_idx = get_free_slot_in_global();</span><br><span class="line">    <span class="keyword">if</span> (fd_idx == <span class="number">-1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        rollback_step = <span class="number">2</span>;</span><br><span class="line">        <span class="keyword">goto</span> rollback;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    file_table[fd_idx].fd_inode = new_file_inode;</span><br><span class="line">    file_table[fd_idx].fd_pos = <span class="number">0</span>;</span><br><span class="line">    file_table[fd_idx].fd_flag = flag;</span><br><span class="line">    file_table[fd_idx].fd_inode-&gt;write_deny = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">dir_entry</span> <span class="title">new_dir_entry</span>;</span></span><br><span class="line">    <span class="built_in">memset</span>(&amp;new_dir_entry, <span class="number">0</span>, <span class="keyword">sizeof</span>(struct dir_entry));</span><br><span class="line"></span><br><span class="line">    create_dir_entry(filename, inode_no, FT_REGULAR, &amp;new_dir_entry);</span><br><span class="line">    <span class="comment">// 同步内存数据到硬盘</span></span><br><span class="line">                                                            </span><br><span class="line">    <span class="comment">/* a 在目录parent_dir下安装目录项new_dir_entry, 写入硬盘后返回true,否则false */</span></span><br><span class="line">    <span class="keyword">if</span> (!sync_dir_entry(parent_dir, &amp;new_dir_entry, io_buf))</span><br><span class="line">    &#123;</span><br><span class="line">        rollback_step = <span class="number">3</span>;</span><br><span class="line">        <span class="keyword">goto</span> rollback;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">memset</span>(io_buf, <span class="number">0</span>, <span class="number">1024</span>);</span><br><span class="line">    <span class="comment">/* b 将父目录i结点的内容同步到硬盘 */</span></span><br><span class="line">    inode_sync(cur_part, parent_dir-&gt;inode, io_buf);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">memset</span>(io_buf, <span class="number">0</span>, <span class="number">1024</span>);</span><br><span class="line">    <span class="comment">/* c 将新创建文件的i结点内容同步到硬盘 */</span></span><br><span class="line">    inode_sync(cur_part, new_file_inode, io_buf);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* d 将inode_bitmap位图同步到硬盘 */</span></span><br><span class="line">    bitmap_sync(cur_part, inode_no, INODE_BITMAP);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* e 将创建的文件i结点添加到open_inodes链表 */</span></span><br><span class="line">    list_push(&amp;cur_part-&gt;open_inodes, &amp;new_file_inode-&gt;inode_tag);</span><br><span class="line">    new_file_inode-&gt;i_open_cnts = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    sys_free(io_buf);</span><br><span class="line">    <span class="keyword">return</span> pcb_fd_install(fd_idx);</span><br><span class="line"></span><br><span class="line"><span class="comment">//创建文件需要创建相关的多个资源,若某步失败则会执行到下面的回滚步骤 </span></span><br><span class="line">rollback:</span><br><span class="line">    <span class="keyword">switch</span> (rollback_step)</span><br><span class="line">    &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">3</span>:</span><br><span class="line">        <span class="comment">/* 失败时,将file_table中的相应位清空 */</span></span><br><span class="line">        <span class="built_in">memset</span>(&amp;file_table[fd_idx], <span class="number">0</span>, <span class="keyword">sizeof</span>(struct file));</span><br><span class="line">    <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">        sys_free(new_file_inode);</span><br><span class="line">    <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">        <span class="comment">/* 如果新文件的i结点创建失败,之前位图中分配的inode_no也要恢复 */</span></span><br><span class="line">        bitmap_set(&amp;cur_part-&gt;inode_bitmap, inode_no, <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    sys_free(io_buf);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>该函数的功能是在目录parent_dir下以创建模式flag去创建普通文件，如果函数执行成功的话返回文件描述符。</p>
<p>创建的过程如下：</p>
<ol>
<li>首先为文件创建inode，该过程需要向inode的管理单元inode_bitmap申请inode号，并更新inode_bitmap</li>
<li>确定文件存储的扇区地址，这个需要在block_bitmap中申请可用的块，并更新block_bitmap</li>
<li>新增的文件必然位于某个目录中，所以该目录的目录项数量要加1，并且要将新增的目录项写入目录对应的扇区中，如果原有的扇区已满，需要申请新扇区来存储目录项</li>
<li>将上面过程中被改变的数据写入硬盘中。</li>
</ol>
<h1 id="系统调用open"><a href="#系统调用open" class="headerlink" title="系统调用open"></a>系统调用open</h1><p>open函数的功能相当强大，通过它的打开标志，不仅可以打开一个文件，同样可以创建一个文件。所以这里不打算单独实现文件的创建。</p>
<p>文件创建的标志<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">enum</span> oflags</span><br><span class="line">&#123;</span><br><span class="line">    O_RDONLY,   <span class="comment">// 只读</span></span><br><span class="line">    O_WRONLY,   <span class="comment">// 只写</span></span><br><span class="line">    O_RDWR,     <span class="comment">// 读写</span></span><br><span class="line">    O_CREAT = <span class="number">4</span> <span class="comment">// 创建</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* 打开或创建文件成功后,返回文件描述符,否则返回-1 */</span></span><br><span class="line"><span class="keyword">int32_t</span> sys_open(<span class="keyword">const</span> <span class="keyword">char</span> *pathname, <span class="keyword">uint8_t</span> flags)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">if</span> (pathname[<span class="built_in">strlen</span>(pathname) - <span class="number">1</span>] == <span class="string">'/'</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	ASSERT(flags &lt;= <span class="number">7</span>);</span><br><span class="line">	<span class="keyword">int32_t</span> fd = <span class="number">-1</span>; <span class="comment">// 默认为找不到</span></span><br><span class="line"></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">path_search_record</span> <span class="title">searched_record</span>;</span></span><br><span class="line">	<span class="built_in">memset</span>(&amp;searched_record, <span class="number">0</span>, <span class="keyword">sizeof</span>(struct path_search_record));</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* 记录目录深度.帮助判断中间某个目录不存在的情况 */</span></span><br><span class="line">	<span class="keyword">uint32_t</span> pathname_depth = path_depth_cnt((<span class="keyword">char</span> *)pathname);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* 先检查文件是否存在 */</span></span><br><span class="line">	<span class="keyword">int</span> inode_no = search_file(pathname, &amp;searched_record);</span><br><span class="line">	<span class="keyword">bool</span> found = inode_no != <span class="number">-1</span> ? <span class="literal">true</span> : <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (searched_record.file_type == FT_DIRECTORY)</span><br><span class="line">	&#123;</span><br><span class="line">		dir_close(searched_record.parent_dir);</span><br><span class="line">		<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">uint32_t</span> path_searched_depth = path_depth_cnt(searched_record.searched_path);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* 先判断是否把pathname的各层目录都访问到了,即是否在某个中间目录就失败了 */</span></span><br><span class="line">	<span class="keyword">if</span> (pathname_depth != path_searched_depth)</span><br><span class="line">	&#123; </span><br><span class="line">        <span class="comment">// 说明并没有访问到全部的路径,某个中间目录是不存在的</span></span><br><span class="line">		dir_close(searched_record.parent_dir);</span><br><span class="line">		<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* 若是在最后一个路径上没找到,并且并不是要创建文件,直接返回-1 */</span></span><br><span class="line">	<span class="keyword">if</span> (!found &amp;&amp; !(flags &amp; O_CREAT))</span><br><span class="line">	&#123;</span><br><span class="line">		dir_close(searched_record.parent_dir);</span><br><span class="line">		<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span> (found &amp;&amp; flags &amp; O_CREAT)</span><br><span class="line">	&#123; </span><br><span class="line">        <span class="comment">// 若要创建的文件已存在</span></span><br><span class="line">		dir_close(searched_record.parent_dir);</span><br><span class="line">		<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">switch</span> (flags &amp; O_CREAT)</span><br><span class="line">	&#123;</span><br><span class="line">	<span class="keyword">case</span> O_CREAT:</span><br><span class="line">		printk(<span class="string">"creating file\n"</span>);</span><br><span class="line">		fd = file_create(searched_record.parent_dir, (<span class="built_in">strrchr</span>(pathname, <span class="string">'/'</span>) + <span class="number">1</span>), flags);</span><br><span class="line">		dir_close(searched_record.parent_dir);</span><br><span class="line">	<span class="comment">// 其余为打开文件</span></span><br><span class="line">	<span class="keyword">default</span>:</span><br><span class="line">		fd = file_open(inode_no, flags);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* 此fd是指任务pcb-&gt;fd_table数组中的元素下标,</span></span><br><span class="line"><span class="comment">      * 并不是指全局file_table中的下标 */</span></span><br><span class="line">	<span class="keyword">return</span> fd;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>文件的创建过程中主要是对路径的解析，这里暂时还不支持相对路径，这里必须使用绝对路径来进行文件的创建。在路径没有问题且该文件不存在的前提下，就会调用之前的file_create函数创建文件。</p>
<p>接下来在模拟器上运行一下，看看创建文件的具体表现</p>
<p><img src="https://melody-pic-1254202436.cos.ap-guangzhou.myqcloud.com/pic/180513/3D3gdG5cdL.png?imageslim" alt="主分区信息"></p>
<p>上面的图片是主分区格式化时数据的区域，我用红框标记了数据的起始扇区位置，该位置应该与根目录所在的位置相同。</p>
<p>将数据起始扇区的位置*512后得到数据区的地址，在该地址处查看512字节也就是一扇区的数据内容，结果如下</p>
<p><img src="https://melody-pic-1254202436.cos.ap-guangzhou.myqcloud.com/pic/180513/CedA9m8Df4.png?imageslim" alt="mark"></p>
<p>在根目录下，目前有三个目录项 <strong>.  ..和创建的文件file1</strong>，每个目录项包含三部分的内容，16字节的filename，4字节的inode号，4字节的文件类型。共24字节的内容</p>
<p>用红框标记的是 <strong>.</strong> 这个目录项的数据，2E代表它的文件名，它表示当前目录也就是根目录，其inode号为0，文件类型为2，代表一个目录</p>
<p>黄线标记的是 <strong>..</strong> 它代表上一层目录，因为目前在根目录下，所以它还是表示根目录。</p>
<p>绿线标记的就是刚刚创建的文件，文件名为file1。inode号为1，文件类型是1，表示这是一个普通文件。</p>
<p>上面通过open函数创建了一个文件，接下来就完成其打开文件的功能。打开文件的功能主要是通过下面这个函数实现的。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* 打开编号为inode_no的inode对应的文件,若成功则返回文件描述符,否则返回-1 */</span></span><br><span class="line"><span class="keyword">int32_t</span> file_open(<span class="keyword">uint32_t</span> inode_no, <span class="keyword">uint8_t</span> flag)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">int</span> fd_idx = get_free_slot_in_global();</span><br><span class="line">    <span class="keyword">if</span> (fd_idx == <span class="number">-1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        printk(<span class="string">"exceed max open files\n"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    file_table[fd_idx].fd_inode = inode_open(cur_part, inode_no);</span><br><span class="line">    file_table[fd_idx].fd_pos = <span class="number">0</span>; <span class="comment">// 每次打开文件,要将fd_pos还原为0,即让文件内的指针指向开头</span></span><br><span class="line">    file_table[fd_idx].fd_flag = flag;</span><br><span class="line">    <span class="keyword">bool</span> *write_deny = &amp;file_table[fd_idx].fd_inode-&gt;write_deny;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (flag &amp; O_WRONLY || flag &amp; O_RDWR)</span><br><span class="line">    &#123;   <span class="comment">// 只要是关于写文件,判断是否有其它进程正写此文件</span></span><br><span class="line">        <span class="comment">// 若是读文件,不考虑write_deny</span></span><br><span class="line">        <span class="comment">/* 以下进入临界区前先关中断 */</span></span><br><span class="line">        <span class="keyword">enum</span> intr_status old_status = intr_disable();</span><br><span class="line">        <span class="keyword">if</span> (!(*write_deny))</span><br><span class="line">        &#123; </span><br><span class="line">            <span class="comment">// 若当前没有其它进程写该文件,将其占用.</span></span><br><span class="line">            *write_deny = <span class="literal">true</span>;          <span class="comment">// 置为true,避免多个进程同时写此文件</span></span><br><span class="line">            intr_set_status(old_status); <span class="comment">// 恢复中断</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123; <span class="comment">// 直接失败返回</span></span><br><span class="line">            intr_set_status(old_status);</span><br><span class="line">            printk(<span class="string">"file can`t be write now, try again later\n"</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="comment">// 若是读文件或创建文件,不用理会write_deny,保持默认</span></span><br><span class="line">    <span class="keyword">return</span> pcb_fd_install(fd_idx);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看到，打开一个文件的本质就是在进程的pcb中安装了该文件对应的文件描述符。</p>
<p>open函数的功能实现完了之后就可以将其添加到系统调用中，以供用户的使用。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">syscall_init</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    syscall_table[SYS_OPEN] = sys_open;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">open</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *pathname, <span class="keyword">int</span> flags)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> _syscall2(SYS_OPEN, pathname, flags);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="系统调用close"><a href="#系统调用close" class="headerlink" title="系统调用close"></a>系统调用close</h1><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* 关闭文件描述符fd指向的文件,成功返回0,否则返回-1 */</span></span><br><span class="line"><span class="keyword">int32_t</span> sys_close(<span class="keyword">int32_t</span> fd)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">int32_t</span> ret = <span class="number">-1</span>;</span><br><span class="line">	<span class="keyword">if</span> (fd &gt; <span class="number">2</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">uint32_t</span> _fd = fd_local2global(fd);</span><br><span class="line">		ret = file_close(&amp;file_table[_fd]);</span><br><span class="line">		running_thread()-&gt;fd_table[fd] = <span class="number">-1</span>; <span class="comment">// 使该文件描述符位可用</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 将文件描述符转化为文件表的下标 */</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> uint32_t <span class="title">fd_local2global</span><span class="params">(<span class="keyword">uint32_t</span> local_fd)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	task_struct *cur = running_thread();</span><br><span class="line">	<span class="keyword">int32_t</span> global_fd = cur-&gt;fd_table[local_fd];</span><br><span class="line">	ASSERT(global_fd &gt;= <span class="number">0</span> &amp;&amp; global_fd &lt; MAX_FILE_OPEN);</span><br><span class="line">	<span class="keyword">return</span> (<span class="keyword">uint32_t</span>)global_fd;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 关闭文件 */</span></span><br><span class="line"><span class="keyword">int32_t</span> file_close(struct file *file)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (file == <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    file-&gt;fd_inode-&gt;write_deny = <span class="literal">false</span>;</span><br><span class="line">    inode_close(file-&gt;fd_inode);</span><br><span class="line">    file-&gt;fd_inode = <span class="literal">NULL</span>; <span class="comment">// 使文件结构可用</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 关闭inode或减少inode的打开数 */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">inode_close</span><span class="params">(struct inode *inode)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">/* 若没有进程再打开此文件,将此inode去掉并释放空间 */</span></span><br><span class="line">    <span class="keyword">enum</span> intr_status old_status = intr_disable();</span><br><span class="line">    <span class="keyword">if</span> (--inode-&gt;i_open_cnts == <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        list_remove(&amp;inode-&gt;inode_tag); <span class="comment">// 将I结点从part-&gt;open_inodes中去掉</span></span><br><span class="line">                                        </span><br><span class="line">        <span class="comment">/* inode_open时为实现inode被所有进程共享,</span></span><br><span class="line"><span class="comment">         * 已经在sys_malloc为inode分配了内核空间,</span></span><br><span class="line"><span class="comment">         * 释放inode时也要确保释放的是内核内存池 */</span></span><br><span class="line">        task_struct *cur = running_thread();</span><br><span class="line">        <span class="keyword">uint32_t</span> *cur_pagedir_bak = cur-&gt;pgdir;</span><br><span class="line">        cur-&gt;pgdir = <span class="literal">NULL</span>;</span><br><span class="line">        sys_free(inode);</span><br><span class="line">        cur-&gt;pgdir = cur_pagedir_bak;</span><br><span class="line">    &#125;</span><br><span class="line">    intr_set_status(old_status);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>添加系统调用</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* 初始化系统调用 */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">syscall_init</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">    syscall_table[SYS_CLOSE] = sys_close;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">close</span><span class="params">(<span class="keyword">int</span> fd)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> _syscall1(SYS_CLOSE, fd);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

      
    </div>

    

    
    
    

    

    
       
    
    

    

    <footer class="post-footer">
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2018/05/12/filesystem2/" rel="next" title="十六. 文件系统二(创建文件系统)">
                <i class="fa fa-chevron-left"></i> 十六. 文件系统二(创建文件系统)
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2018/05/14/filesystem4/" rel="prev" title="十八. 文件系统四(文件的读写与删除)">
                十八. 文件系统四(文件的读写与删除) <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>


  </div>


          </div>
          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="/images/avatar.jpg" alt="melody">
            
              <p class="site-author-name" itemprop="name">melody</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">37</span>
                    <span class="site-state-item-name">日志</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  <a href="/categories/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">3</span>
                    <span class="site-state-item-name">分类</span>
                  </a>
                </div>
              

              
            </nav>
          

          

          
            <div class="links-of-author motion-element">
              
                <span class="links-of-author-item">
                  
                  
                    
                  
                  
                    
                  
                  <a href="https://github.com/melodywei" title="GitHub &rarr; https://github.com/melodywei" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i>GitHub</a>
                </span>
              
                <span class="links-of-author-item">
                  
                  
                    
                  
                  
                    
                  
                  <a href="mailto:melodywei97@gmail.com" title="E-Mail &rarr; mailto:melodywei97@gmail.com" rel="noopener" target="_blank"><i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                </span>
              
            </div>
          

          

          
          

          
            
          
          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#文件描述符"><span class="nav-number">1.</span> <span class="nav-text">文件描述符</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#创建文件"><span class="nav-number">2.</span> <span class="nav-text">创建文件</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#系统调用open"><span class="nav-number">3.</span> <span class="nav-text">系统调用open</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#系统调用close"><span class="nav-number">4.</span> <span class="nav-text">系统调用close</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2018</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">melody</span>

  

  
</div>


  <div class="powered-by">由 <a href="https://hexo.io" class="theme-link" rel="noopener" target="_blank">Hexo</a> 强力驱动 v3.8.0</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 – <a href="https://theme-next.org" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a> v6.5.0</div>




        








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    
	
    

    
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


























  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=6.5.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=6.5.0"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=6.5.0"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=6.5.0"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=6.5.0"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=6.5.0"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=6.5.0"></script>



  



  










  





  

  

  

  

  

  
  

  

  

  

  

  

  

</body>
</html>
